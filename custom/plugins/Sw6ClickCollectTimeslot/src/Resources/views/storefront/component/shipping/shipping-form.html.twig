{% sw_extends '@Storefront/storefront/component/shipping/shipping-form.html.twig' %}

{% block component_shipping_form %}
    <div class="shipping-method-form" data-form-auto-submit="true">
        <div class="shipping-method-select">
            <label for="shippingMethodSelect" class="form-label">Versandart</label>
            <select id="shippingMethodSelect" name="shippingMethodSelect" class="form-select shipping-method-dropdown">
                <option value="standard">Standard</option>
                <option value="click-collect">Abholung im Store</option>
            </select>
        </div>

        {# Timeslots - only visible when Click & Collect is selected #}
        <div class="shipping-method-timeslots click-collect-timeslot" data-click-collect style="margin-top: 20px; display: none;">
            <h5 class="mb-3">Zeitfenster wählen</h5>
            
            <div class="timeslot-options">
                <div class="form-check">
                    <input type="checkbox" name="sw_timeslot[]" value="timeslot1" class="form-check-input timeslot-checkbox" id="timeslot1">
                    <label class="form-check-label" for="timeslot1">09:00 - 11:00 Uhr</label>
                </div>
                <div class="form-check">
                    <input type="checkbox" name="sw_timeslot[]" value="timeslot2" class="form-check-input timeslot-checkbox" id="timeslot2">
                    <label class="form-check-label" for="timeslot2">11:00 - 13:00 Uhr</label>
                </div>
                <div class="form-check">
                    <input type="checkbox" name="sw_timeslot[]" value="timeslot3" class="form-check-input timeslot-checkbox" id="timeslot3">
                    <label class="form-check-label" for="timeslot3">13:00 - 15:00 Uhr</label>
                </div>
            </div>
            <div class="click-collect-notice" data-click-collect-notice></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const shippingSelect = document.getElementById('shippingMethodSelect');
            const timeslotContainer = document.querySelector('[data-click-collect]');
            const timeslotCheckboxes = document.querySelectorAll('.timeslot-checkbox');

            function hideTimeslots() {
                if (timeslotContainer) {
                    timeslotContainer.style.display = 'none';
                }
            }

            function showTimeslots() {
                if (timeslotContainer) {
                    timeslotContainer.style.display = 'block';
                }
            }

            function showError(message) {
                const existingError = document.querySelector('.click-collect-error');
                if (existingError) {
                    existingError.remove();
                }

                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger click-collect-error';
                errorDiv.style.marginTop = '10px';
                errorDiv.innerHTML = '<div class="alert-content">' + message + '</div>';

                if (timeslotContainer) {
                    timeslotContainer.appendChild(errorDiv);
                    errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                setTimeout(function() {
                    if (errorDiv.parentNode) {
                        errorDiv.remove();
                    }
                }, 5000);
            }

            if (shippingSelect) {
                shippingSelect.addEventListener('change', function() {
                    if (this.value === 'click-collect') {
                        showTimeslots();
                    } else {
                        hideTimeslots();
                        timeslotCheckboxes.forEach(cb => cb.checked = false);
                    }
                });
            }

            // Validate checkout when button is clicked
            function validateCheckout(e) {
                if (shippingSelect && shippingSelect.value === 'click-collect') {
                    const selectedCheckboxes = timeslotContainer ? timeslotContainer.querySelectorAll('input[name="sw_timeslot[]"]:checked') : [];
                    if (selectedCheckboxes.length === 0) {
                        e.preventDefault();
                        e.stopPropagation();
                        showError('Bitte wählen Sie mindestens ein Zeitfenster aus');
                        return false;
                    }
                }
            }

            // Find and bind to checkout form
            const checkoutForm = document.querySelector('form[name="confirmOrderForm"]') || 
                                document.querySelector('#confirmOrderForm') ||
                                document.querySelector('form[action*="checkout/confirm"]');
            
            if (checkoutForm) {
                checkoutForm.addEventListener('submit', function(e) {
                    if (shippingSelect && shippingSelect.value === 'click-collect') {
                        const selectedCheckboxes = timeslotContainer ? timeslotContainer.querySelectorAll('input[name="sw_timeslot[]"]:checked') : [];
                        if (selectedCheckboxes.length > 0) {
                            // Add hidden input with selected timeslots
                            const existingHidden = checkoutForm.querySelector('input[type="hidden"][name="sw_timeslot"]');
                            if (existingHidden) existingHidden.remove();

                            const hiddenInput = document.createElement('input');
                            hiddenInput.type = 'hidden';
                            hiddenInput.name = 'sw_timeslot';
                            hiddenInput.value = Array.from(selectedCheckboxes).map(cb => cb.value).join(',');
                            checkoutForm.appendChild(hiddenInput);

                            // Add hidden input for click collect flag
                            const existingFlag = checkoutForm.querySelector('input[type="hidden"][name="sw_click_collect_is_pickup"]');
                            if (existingFlag) existingFlag.remove();

                            const flagInput = document.createElement('input');
                            flagInput.type = 'hidden';
                            flagInput.name = 'sw_click_collect_is_pickup';
                            flagInput.value = '1';
                            checkoutForm.appendChild(flagInput);
                        }
                    }
                    validateCheckout(e);
                });
            }

            // Also bind to confirm button
            const confirmButton = document.querySelector('.btn.checkout-confirm-submit') ||
                                 document.querySelector('button[type="submit"][form="confirmOrderForm"]') ||
                                 document.querySelector('.checkout-confirm-form-submit');
            
            if (confirmButton) {
                confirmButton.addEventListener('click', validateCheckout);
            }
        });
    </script>
{% endblock %}
