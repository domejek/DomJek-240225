{% sw_extends '@Storefront/storefront/component/shipping/shipping-form.html.twig' %}

{% block component_shipping_form_list %}
    <div class="shipping-methods">
        {% for shipping in page.shippingMethods %}
            {% block component_shipping_form_method %}
                {% sw_include '@Storefront/storefront/component/shipping/shipping-method.html.twig' %}
            {% endblock %}
        {% endfor %}

        {# Click & Collect - Store Pickup Option #}
        {% block component_shipping_form_click_collect %}
            <div class="shipping-method-click-collect">
                <label class="form-check">
                    <input type="radio" name="shippingMethod" value="click-collect" class="form-check-input click-collect-toggle" data-toggle-timeslots>
                    <span class="form-check-label">Abholung im Store</span>
                </label>

                {# Timeslots - only visible when Click & Collect is selected #}
                <div class="shipping-method-timeslots click-collect-timeslot" data-click-collect style="margin: 15px 0 15px 30px; display: none;">
                    <div class="timeslots">
                        <h5 class="mb-2">Zeitfenster wählen</h5>
                        
                        <div class="timeslot-options">
                            <label class="form-check">
                                <input type="radio" name="sw_timeslot" value="timeslot1" class="form-check-input">
                                <span class="form-check-label">09:00 - 11:00 Uhr</span>
                            </label>
                            <label class="form-check">
                                <input type="radio" name="sw_timeslot" value="timeslot2" class="form-check-input">
                                <span class="form-check-label">11:00 - 13:00 Uhr</span>
                            </label>
                            <label class="form-check">
                                <input type="radio" name="sw_timeslot" value="timeslot3" class="form-check-input">
                                <span class="form-check-label">13:00 - 15:00 Uhr</span>
                            </label>
                        </div>
                    </div>
                    <div class="click-collect-notice" data-click-collect-notice></div>
                </div>
            </div>
        {% endblock %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const clickCollectToggle = document.querySelector('[data-toggle-timeslots]');
            const timeslotContainer = document.querySelector('[data-click-collect]');
            const allRadioButtons = document.querySelectorAll('input[name="shippingMethod"]');
            const standardShippingMethods = document.querySelectorAll('.shipping-method');
            let isClickCollectSelected = false;

            function hideTimeslots() {
                if (timeslotContainer) {
                    timeslotContainer.style.display = 'none';
                }
            }

            function showTimeslots() {
                if (timeslotContainer) {
                    timeslotContainer.style.display = 'block';
                }
            }

            function hideStandardShippingMethods() {
                standardShippingMethods.forEach(function(method) {
                    method.style.display = 'none';
                });
            }

            function showStandardShippingMethods() {
                standardShippingMethods.forEach(function(method) {
                    method.style.display = '';
                });
            }

            function showError(message) {
                // Remove existing error message
                const existingError = document.querySelector('.click-collect-error');
                if (existingError) {
                    existingError.remove();
                }

                // Create error element
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger click-collect-error';
                errorDiv.style.marginTop = '10px';
                errorDiv.innerHTML = '<div class="alert-content">' + message + '</div>';

                // Insert after the timeslot container
                if (timeslotContainer) {
                    timeslotContainer.appendChild(errorDiv);
                    
                    // Scroll to error
                    errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                // Auto-remove after 5 seconds
                setTimeout(function() {
                    if (errorDiv.parentNode) {
                        errorDiv.remove();
                    }
                }, 5000);
            }

            if (clickCollectToggle) {
                clickCollectToggle.addEventListener('change', function() {
                    if (this.checked) {
                        showTimeslots();
                        hideStandardShippingMethods();
                        isClickCollectSelected = true;
                    } else {
                        hideTimeslots();
                        showStandardShippingMethods();
                        isClickCollectSelected = false;
                    }
                });
            }

            // Hide timeslots when any other shipping method is selected
            allRadioButtons.forEach(function(radio) {
                radio.addEventListener('change', function() {
                    if (this !== clickCollectToggle && this.checked) {
                        hideTimeslots();
                        showStandardShippingMethods();
                        isClickCollectSelected = false;
                    }
                });
            });

            // Checkout validation
            function validateCheckout(e) {
                if (isClickCollectSelected) {
                    const selectedTimeslot = timeslotContainer ? timeslotContainer.querySelector('input[name="sw_timeslot"]:checked') : null;
                    if (!selectedTimeslot) {
                        e.preventDefault();
                        e.stopPropagation();
                        showError('Kein Zeitfenster ausgewählt');
                        return false;
                    }
                }
            }

            // Find and bind to checkout form
            const checkoutForm = document.querySelector('form[name="confirmOrderForm"]') || 
                                document.querySelector('#confirmOrderForm') ||
                                document.querySelector('form[action*="checkout/confirm"]');
            
            if (checkoutForm) {
                checkoutForm.addEventListener('submit', validateCheckout);
            }

            // Also bind to confirm button
            const confirmButton = document.querySelector('.btn.checkout-confirm-submit') ||
                                 document.querySelector('button[type="submit"][form="confirmOrderForm"]') ||
                                 document.querySelector('.checkout-confirm-form-submit');
            
            if (confirmButton) {
                confirmButton.addEventListener('click', validateCheckout);
            }
        });
    </script>
{% endblock %}



